# Azure Resource Manager Template for SmartSupply Health
# This template creates all necessary Azure resources

name: SmartSupply-Health-Deployment
apiVersion: 2019-10-01
location: '[resourceGroup().location]'

resources:
  # Azure Container Registry
  - type: Microsoft.ContainerRegistry/registries
    apiVersion: 2019-05-01
    name: smartsupplyregistry
    location: '[resourceGroup().location]'
    sku:
      name: Basic
    properties:
      adminUserEnabled: true

  # App Service Plan
  - type: Microsoft.Web/serverfarms
    apiVersion: 2018-02-01
    name: smartsupply-app-plan
    location: '[resourceGroup().location]'
    sku:
      name: B1
      tier: Basic
    properties:
      reserved: true

  # Web App
  - type: Microsoft.Web/sites
    apiVersion: 2018-11-01
    name: smartsupply-health-app
    location: '[resourceGroup().location]'
    dependsOn:
      - smartsupply-app-plan
    properties:
      serverFarmId: '[resourceId('Microsoft.Web/serverfarms', 'smartsupply-app-plan')]'
      siteConfig:
        linuxFxVersion: 'DOCKER|smartsupplyregistry.azurecr.io/smartsupply-health:latest'
        appSettings:
          - name: 'DOCKER_REGISTRY_SERVER_URL'
            value: 'https://smartsupplyregistry.azurecr.io'
          - name: 'DOCKER_REGISTRY_SERVER_USERNAME'
            value: '[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', 'smartsupplyregistry'), '2019-05-01').username]'
          - name: 'DOCKER_REGISTRY_SERVER_PASSWORD'
            value: '[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', 'smartsupplyregistry'), '2019-05-01').passwords[0].value]'
          - name: 'WEBSITES_ENABLE_APP_SERVICE_STORAGE'
            value: 'false'
          - name: 'NODE_ENV'
            value: 'production'
          - name: 'PORT'
            value: '5000'

  # Cosmos DB (MongoDB API)
  - type: Microsoft.DocumentDB/databaseAccounts
    apiVersion: 2020-04-01
    name: smartsupply-cosmos
    location: '[resourceGroup().location]'
    properties:
      databaseAccountOfferType: Standard
      locations:
        - locationName: '[resourceGroup().location]'
          failoverPriority: 0
      capabilities:
        - name: EnableMongo
      consistencyPolicy:
        defaultConsistencyLevel: Session
      enableMultipleWriteLocations: false
      isVirtualNetworkFilterEnabled: false
      enableAutomaticFailover: false

  # Application Insights
  - type: Microsoft.Insights/components
    apiVersion: 2020-02-02
    name: smartsupply-insights
    location: '[resourceGroup().location]'
    kind: web
    properties:
      Application_Type: web
      RetentionInDays: 90

outputs:
  webAppUrl:
    type: string
    value: '[concat('https://', reference('smartsupply-health-app').defaultHostName)]'
  cosmosConnectionString:
    type: string
    value: '[listConnectionStrings(resourceId('Microsoft.DocumentDB/databaseAccounts', 'smartsupply-cosmos'), '2020-04-01').connectionStrings[0].connectionString]'
